<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Football Analytics Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 p-4">
    <div class="flex space-x-8 items-center">
      <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Analytics Dashboard</h1>
      <div class="flex space-x-6">
        <button onclick="showSection('league')" class="nav-btn text-lg font-semibold text-blue-600 dark:text-blue-400 border-b-2 border-blue-600 dark:border-blue-400 pb-1" data-section="league">
          League
        </button>
        <button onclick="showSection('players')" class="nav-btn text-lg font-semibold text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200" data-section="players">
          Players
        </button>
      </div>
    </div>
  </header>

  <section id="league-section" class="section-content">
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <p class="text-gray-500 dark:text-gray-400 text-sm">Current Gameweek</p>
                <h2 id="current-gameweek" class="text-3xl font-bold">5</h2>
            </div>
        </div>
    </div>

    <div class="p-6 pt-0">
      <div class="mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
          <h3 class="text-lg font-semibold mb-4">Select Teams to Compare</h3>
          <div id="team-checkboxes" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="score-chart-title" class="text-lg font-semibold">Score Trends by Gameweek</h3>
                <select id="score-chart-selector" onchange="updateLeagueView()" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                    <option value="weekly" selected>Weekly Score</option>
                    <option value="cumulative">Cumulative Score</option>
                </select>
            </div>
            <canvas id="score-trends-chart" width="400" height="300"></canvas>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="win-trends-title" class="text-lg font-semibold">Cumulative Wins</h3>
                <select id="win-trends-selector" onchange="updateLeagueView()" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                    <option value="cumulative" selected>Cumulative Wins</option>
                    <option value="result">Match Result</option>
                </select>
            </div>
            <canvas id="win-trends-chart" width="400" height="300"></canvas>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
          <h3 class="text-lg font-semibold mb-4">Win Rate by Team</h3>
          <canvas id="win-rate-chart" width="400" height="300"></canvas>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4">Team Performance Matrix</h3>
            <canvas id="performance-matrix-chart" width="800" height="400"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
        <h3 class="text-xl font-bold mb-4">League Standings</h3>
        <div class="overflow-x-auto">
          <table id="standings-table" class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <th class="text-left py-2">Pos</th>
                <th class="text-left py-2">Team</th>
                <th class="text-left py-2">W</th>
                <th class="text-left py-2">L</th>
                <th class="text-left py-2">Points For</th>
                <th class="text-left py-2">Points Against</th>
                <th class="text-left py-2">Avg Score</th>
              </tr>
            </thead>
            <tbody id="standings-body">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section id="players-section" class="section-content hidden">
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <p class="text-gray-500 dark:text-gray-400 text-sm">Total Players</p>
                <h2 id="total-players" class="text-3xl font-bold">0</h2>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <p class="text-gray-500 dark:text-gray-400 text-sm">Top Scorer (Latest GW)</p>
                <h2 id="top-scorer-name" class="text-xl font-bold">Loading...</h2>
                <p id="top-scorer-pts" class="text-sm">-- FPts</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <p class="text-gray-500 dark:text-gray-400 text-sm">Avg. Points (Latest GW)</p>
                <h2 id="avg-points" class="text-3xl font-bold">0</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Transaction Impact Analysis</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Actual net points gained or lost from player adds/drops over the season.</p>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-200 dark:border-gray-700">
                            <th class="text-left py-2">Rank</th>
                            <th class="text-left py-2">Team</th>
                            <th class="text-left py-2">Net Points Impact</th>
                        </tr>
                    </thead>
                    <tbody id="impact-analysis-body">
                        </tbody>
                </table>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Recent Transactions</h3>
                <div class="overflow-y-auto h-64">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <th class="text-left py-2">Player</th>
                                <th class="text-left py-2">Type</th>
                                <th class="text-left py-2">Team</th>
                                <th class="text-left py-2">GW</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-log-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
        <h3 id="player-stats-title" class="text-xl font-bold mb-4">Player Statistics</h3>
        <table id="players-table" class="display stripe hover w-full text-sm"></table>
      </div>
    </div>
  </section>

  <script>
    let matchData = [], transactionData = [], weeklyPlayerData = {}, charts = {};
    const CURRENT_GAMEWEEK = 5;
    const teamColors = { "Book Ake": "#4299E1", "Bryan MBeumboclaat": "#E53E3E", "Chicken Tikka MoSalah": "#38A169", "Ekitiki-taka": "#ECC94B", "ESRs EDL for FPL": "#9F7AEA", "FPL Loyalists": "#ED8936", "Haile Senesi": "#3182CE", "I'm a Baleba": "#D53F8C", "Infantino Milan": "#4FD1C5", "Iwobi Wan-Kenobi": "#F6AD55", "Me,Myself,Ndiaye": "#805AD5", "Texas Chainshaw Massacre": "#2C7A7B", "Ugarte roll with it": "#A0AEC0" };
    function getTeamColor(teamName) { return teamColors[teamName] || '#9CA3AF'; }

    // --- ADDED: Self-contained sample data for testing ---
    const sampleTransactionData = [
        { Gameweek: '5', Player: 'James Hill', Type: 'Add', Team: 'Book Ake' },
        { Gameweek: '5', Player: 'Quilindschy Hartman', Type: 'Drop', Team: 'Book Ake' },
        { Gameweek: '4', Player: 'Marco Bizot', Type: 'Add', Team: 'FPL Loyalists' },
        { Gameweek: '4', Player: 'Lucas Bergvall', Type: 'Drop', Team: 'FPL Loyalists' },
        { Gameweek: '3', Player: 'Ivan Toney', Type: 'Add', Team: 'Chicken Tikka MoSalah' },
        { Gameweek: '3', Player: 'Kaoru Mitoma', Type: 'Drop', Team: 'Chicken Tikka MoSalah' },
    ];

    const sampleWeeklyPlayerData = {
        '1': [],
        '2': [],
        '3': [
            { Player: 'Ivan Toney', FPts: '12.5', Team: 'BRE', Position: 'FWD' },
            { Player: 'Kaoru Mitoma', FPts: '3.0', Team: 'BHA', Position: 'MID' },
        ],
        '4': [
            { Player: 'Marco Bizot', FPts: '8.0', Team: 'BRE', Position: 'GKP' },
            { Player: 'Lucas Bergvall', FPts: '1.0', Team: 'TOT', Position: 'MID' },
            { Player: 'Ivan Toney', FPts: '5.0', Team: 'BRE', Position: 'FWD' },
            { Player: 'Kaoru Mitoma', FPts: '7.5', Team: 'BHA', Position: 'MID' },
        ],
        '5': [
            { Player: 'James Hill', FPts: '6.5', Team: 'BOU', Position: 'DEF' },
            { Player: 'Quilindschy Hartman', FPts: '2.0', Team: 'FA', Position: 'DEF' },
            { Player: 'Marco Bizot', FPts: '5.0', Team: 'BRE', Position: 'GKP' },
            { Player: 'Lucas Bergvall', FPts: '0.5', Team: 'TOT', Position: 'MID' },
            { Player: 'Ivan Toney', FPts: '9.0', Team: 'BRE', Position: 'FWD' },
            { Player: 'Kaoru Mitoma', FPts: '2.5', Team: 'BHA', Position: 'MID' },
        ]
    };

    const matchRecordsCSV = `Gameweek,Start_Date,End_Date,Team,Score,Opponent,Opp_Score,Result
1,Fri Aug 15 2025,Thu Aug 21 2025,FPL Loyalists,116.5,"Me,Myself,Ndiaye",107.75,W
1,Fri Aug 15 2025,Thu Aug 21 2025,"Me,Myself,Ndiaye",107.75,FPL Loyalists,116.5,L
1,Fri Aug 15 2025,Thu Aug 21 2025,Book Ake,121.5,ESRs EDL for FPL,91.83,W
1,Fri Aug 15 2025,Thu Aug 21 2025,ESRs EDL for FPL,91.83,Book Ake,121.5,L
1,Fri Aug 15 2025,Thu Aug 21 2025,Texas Chainshaw Massacre,112.67,Bryan MBeumboclaat,82.3,W
1,Fri Aug 15 2025,Thu Aug 21 2025,Bryan MBeumboclaat,82.3,Texas Chainshaw Massacre,112.67,L
1,Fri Aug 15 2025,Thu Aug 21 2025,I'm a Baleba,180.72,Infantino Milan,116.36,W
1,Fri Aug 15 2025,Thu Aug 21 2025,Infantino Milan,116.36,I'm a Baleba,180.72,L
1,Fri Aug 15 2025,Thu Aug 21 2025,Haile Senesi,94.22,*League Average*,113.106,L
1,Fri Aug 15 2025,Thu Aug 21 2025,*League Average*,113.106,Haile Senesi,94.22,W
1,Fri Aug 15 2025,Thu Aug 21 2025,Chicken Tikka MoSalah,138.88,Iwobi Wan-Kenobi,127.84,W
1,Fri Aug 15 2025,Thu Aug 21 2025,Iwobi Wan-Kenobi,127.84,Chicken Tikka MoSalah,138.88,L
1,Fri Aug 15 2025,Thu Aug 21 2025,Ugarte roll with it,112.68,Ekitiki-taka,67.13,W
1,Fri Aug 15 2025,Thu Aug 21 2025,Ekitiki-taka,67.13,Ugarte roll with it,112.68,L
2,Fri Aug 22 2025,Thu Aug 28 2025,"Me,Myself,Ndiaye",114.62,Book Ake,128.65,L
2,Fri Aug 22 2025,Thu Aug 28 2025,Book Ake,128.65,"Me,Myself,Ndiaye",114.62,W
2,Fri Aug 22 2025,Thu Aug 28 2025,FPL Loyalists,95.03,Texas Chainshaw Massacre,103.64,L
2,Fri Aug 22 2025,Thu Aug 28 2025,Texas Chainshaw Massacre,103.64,FPL Loyalists,95.03,W
2,Fri Aug 22 2025,Thu Aug 28 2025,ESRs EDL for FPL,127.51,I'm a Baleba,111.67,W
2,Fri Aug 22 2025,Thu Aug 28 2025,I'm a Baleba,111.67,ESRs EDL for FPL,127.51,L
2,Fri Aug 22 2025,Thu Aug 28 2025,Bryan MBeumboclaat,93.97,Haile Senesi,107.67,L
2,Fri Aug 22 2025,Thu Aug 28 2025,Haile Senesi,107.67,Bryan MBeumboclaat,93.97,W
2,Fri Aug 22 2025,Thu Aug 28 2025,Infantino Milan,128.77,Chicken Tikka MoSalah,109.73,W
2,Fri Aug 22 2025,Thu Aug 28 2025,Chicken Tikka MoSalah,109.73,Infantino Milan,128.77,L
2,Fri Aug 22 2025,Thu Aug 28 2025,*League Average*,106.528,Ugarte roll with it,105.66,W
2,Fri Aug 22 2025,Thu Aug 28 2025,Ugarte roll with it,105.66,*League Average*,106.528,L
2,Fri Aug 22 2025,Thu Aug 28 2025,Iwobi Wan-Kenobi,61.35,Ekitiki-taka,96.6,L
2,Fri Aug 22 2025,Thu Aug 28 2025,Ekitiki-taka,96.6,Iwobi Wan-Kenobi,61.35,W
3,Fri Aug 29 2025,Thu Sep 11 2025,Texas Chainshaw Massacre,112.55,"Me,Myself,Ndiaye",84.2,W
3,Fri Aug 29 2025,Thu Sep 11 2025,"Me,Myself,Ndiaye",84.2,Texas Chainshaw Massacre,112.55,L
3,Fri Aug 29 2025,Thu Sep 11 2025,I'm a Baleba,60.32,Book Ake,115.18,L
3,Fri Aug 29 2025,Thu Sep 11 2025,Book Ake,115.18,I'm a Baleba,60.32,W
3,Fri Aug 29 2025,Thu Sep 11 2025,Haile Senesi,142.27,FPL Loyalists,72.6,W
3,Fri Aug 29 2025,Thu Sep 11 2025,FPL Loyalists,72.6,Haile Senesi,142.27,L
3,Fri Aug 29 2025,Thu Sep 11 2025,Chicken Tikka MoSalah,121.08,ESRs EDL for FPL,110.67,W
3,Fri Aug 29 2025,Thu Sep 11 2025,ESRs EDL for FPL,110.67,Chicken Tikka MoSalah,121.08,L
3,Fri Aug 29 2025,Thu Sep 11 2025,Ugarte roll with it,109.79,Bryan MBeumboclaat,93.48,W
3,Fri Aug 29 2025,Thu Sep 11 2025,Bryan MBeumboclaat,93.48,Ugarte roll with it,109.79,L
3,Fri Aug 29 2025,Thu Sep 11 2025,Ekitiki-taka,74.9,Infantino Milan,94.55,L
3,Fri Aug 29 2025,Thu Sep 11 2025,Infantino Milan,94.55,Ekitiki-taka,74.9,W
3,Fri Aug 29 2025,Thu Sep 11 2025,Iwobi Wan-Kenobi,106.57,*League Average*,99.858,W
3,Fri Aug 29 2025,Thu Sep 11 2025,*League Average*,99.858,Iwobi Wan-Kenobi,106.57,L
4,Fri Sep 12 2025,Thu Sep 18 2025,"Me,Myself,Ndiaye",103.58,I'm a Baleba,126.16,L
4,Fri Sep 12 2025,Thu Sep 18 2025,I'm a Baleba,126.16,"Me,Myself,Ndiaye",103.58,W
4,Fri Sep 12 2025,Thu Sep 18 2025,Texas Chainshaw Massacre,129.53,Haile Senesi,100.52,W
4,Fri Sep 12 2025,Thu Sep 18 2025,Haile Senesi,100.52,Texas Chainshaw Massacre,129.53,L
4,Fri Sep 12 2025,Thu Sep 18 2025,Book Ake,131.98,Chicken Tikka MoSalah,103.84,W
4,Fri Sep 12 2025,Thu Sep 18 2025,Chicken Tikka MoSalah,103.84,Book Ake,131.98,L
4,Fri Sep 12 2025,Thu Sep 18 2025,FPL Loyalists,111.5,Ugarte roll with it,109.75,W
4,Fri Sep 12 2025,Thu Sep 18 2025,Ugarte roll with it,109.75,FPL Loyalists,111.5,L
4,Fri Sep 12 2025,Thu Sep 18 2025,ESRs EDL for FPL,113.62,Ekitiki-taka,80.53,W
4,Fri Sep 12 2025,Thu Sep 18 2025,Ekitiki-taka,80.53,ESRs EDL for FPL,113.62,L
4,Fri Sep 12 2025,Thu Sep 18 2025,Bryan MBeumboclaat,102.73,Iwobi Wan-Kenobi,110.27,L
4,Fri Sep 12 2025,Thu Sep 18 2025,Iwobi Wan-Kenobi,110.27,Bryan MBeumboclaat,102.73,W
4,Fri Sep 12 2025,Thu Sep 18 2025,Infantino Milan,135.82,*League Average*,112.295,W
4,Fri Sep 12 2025,Thu Sep 18 2025,*League Average*,112.295,Infantino Milan,135.82,L
5,Fri Sep 19 2025,Thu Sep 25 2025,Haile Senesi,90.57,"Me,Myself,Ndiaye",80.53,W
5,Fri Sep 19 2025,Thu Sep 25 2025,"Me,Myself,Ndiaye",80.53,Haile Senesi,90.57,L
5,Fri Sep 19 2025,Thu Sep 25 2025,Chicken Tikka MoSalah,134.6,I'm a Baleba,130.82,W
5,Fri Sep 19 2025,Thu Sep 25 2025,I'm a Baleba,130.82,Chicken Tikka MoSalah,134.6,L
5,Fri Sep 19 2025,Thu Sep 25 2025,Ugarte roll with it,46.52,Texas Chainshaw Massacre,81.5,L
5,Fri Sep 19 2025,Thu Sep 25 2025,Texas Chainshaw Massacre,81.5,Ugarte roll with it,46.52,W
5,Fri Sep 19 2025,Thu Sep 25 2025,Ekitiki-taka,100.58,Book Ake,105.31,L
5,Fri Sep 19 2025,Thu Sep 25 2025,Book Ake,105.31,Ekitiki-taka,100.58,W
5,Fri Sep 19 2025,Thu Sep 25 2025,Iwobi Wan-Kenobi,147.7,FPL Loyalists,83.39,W
5,Fri Sep 19 2025,Thu Sep 25 2025,FPL Loyalists,83.39,Iwobi Wan-Kenobi,147.7,L
5,Fri Sep 19 2025,Thu Sep 25 2025,*League Average*,100.678,ESRs EDL for FPL,99.67,W
5,Fri Sep 19 2025,Thu Sep 25 2025,ESRs EDL for FPL,99.67,*League Average*,100.678,L
5,Fri Sep 19 2025,Thu Sep 25 2025,Infantino Milan,107.4,Bryan MBeumboclaat,100.23,W
5,Fri Sep 19 2025,Thu Sep 25 2025,Bryan MBeumboclaat,100.23,Infantino Milan,107.4,L`;

    function showSection(sectionName) {
      document.querySelectorAll('.section-content').forEach(section => section.classList.add('hidden'));
      document.getElementById(sectionName + '-section').classList.remove('hidden');
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('text-blue-600', 'dark:text-blue-400', 'border-b-2', 'border-blue-600', 'dark:border-blue-400');
        btn.classList.add('text-gray-500', 'dark:text-gray-400', 'hover:text-gray-800', 'dark:hover:text-gray-200');
      });
      const activeBtn = document.querySelector(`[data-section="${sectionName}"]`);
      activeBtn.classList.add('text-blue-600', 'dark:text-blue-400', 'border-b-2', 'border-blue-600', 'dark:border-blue-400');
      activeBtn.classList.remove('text-gray-500', 'dark:text-gray-400');
      if (sectionName === 'league' && Object.keys(charts).length === 0) {
          setTimeout(initializeCharts, 100); 
      }
    }

    function parseMatchData() {
      matchData = Papa.parse(matchRecordsCSV, { header: true, skipEmptyLines: true }).data.filter(row => row.Team !== '*League Average*');
    }

    function calculateStandings() {
      const teamStats = {};
      matchData.forEach(match => {
        const team = match.Team;
        if (!teamStats[team]) { teamStats[team] = { wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0, games: 0 }; }
        teamStats[team].games++;
        teamStats[team].pointsFor += parseFloat(match.Score);
        teamStats[team].pointsAgainst += parseFloat(match.Opp_Score);
        if (match.Result === 'W') teamStats[team].wins++; else teamStats[team].losses++;
      });
      return Object.entries(teamStats).map(([team, stats]) => ({
        team, wins: stats.wins, losses: stats.losses, pointsFor: stats.pointsFor.toFixed(1),
        pointsAgainst: stats.pointsAgainst.toFixed(1), avgScore: (stats.pointsFor / stats.games).toFixed(1)
      })).sort((a, b) => {
        if (b.wins !== a.wins) return b.wins - a.wins;
        return parseFloat(b.avgScore) - parseFloat(a.avgScore);
      });
    }
    
    function renderStandings(selectedTeams) {
      const fullStandings = calculateStandings();
      const tbody = document.getElementById('standings-body');
      tbody.innerHTML = '';
      if (!selectedTeams || selectedTeams.length === 0) return;
      const filteredStandings = fullStandings.filter(teamData => selectedTeams.includes(teamData.team));
      filteredStandings.forEach(team => {
        const originalRank = fullStandings.findIndex(t => t.team === team.team) + 1;
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-100 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700';
        row.innerHTML = `<td class="py-2 font-semibold">${originalRank}</td><td class="py-2">${team.team}</td><td class="py-2 text-green-600 font-semibold">${team.wins}</td><td class="py-2 text-red-600 font-semibold">${team.losses}</td><td class="py-2">${team.pointsFor}</td><td class="py-2">${team.pointsAgainst}</td><td class="py-2 font-semibold">${team.avgScore}</td>`;
        tbody.appendChild(row);
      });
    }
    
    function calculateAndRenderImpact() {
        if (Object.keys(weeklyPlayerData).length === 0 || transactionData.length === 0) {
            console.log("Waiting for data to calculate impact...");
            return;
        }
        
        const impact = {};
        const allTeams = [...new Set(matchData.map(m => m.Team))];
        allTeams.forEach(team => impact[team] = 0);

        transactionData.forEach(t => {
            const transactionGW = parseInt(t.Gameweek);
            const teamName = t.Team ? t.Team.trim() : null;
            const playerName = t.Player ? t.Player.trim().toLowerCase() : null;

            if (!transactionGW || !teamName || !playerName) return;

            let actualPoints = 0;
            for (let gw = transactionGW; gw <= CURRENT_GAMEWEEK; gw++) {
                const weeklyData = weeklyPlayerData[gw];
                if (!weeklyData) continue;
                const playerStats = weeklyData.find(p => p.Player && p.Player.trim().toLowerCase() === playerName);
                if (playerStats) { actualPoints += parseFloat(playerStats['FPts']) || 0; }
            }

            if (impact.hasOwnProperty(teamName)) {
                if (t.Type.toLowerCase() === 'add') {
                    impact[teamName] += actualPoints;
                } else if (t.Type.toLowerCase() === 'drop') {
                    impact[teamName] -= actualPoints;
                }
            }
        });

        const sortedImpact = Object.entries(impact).sort(([,a],[,b]) => b - a);
        const impactBody = document.getElementById('impact-analysis-body');
        impactBody.innerHTML = '';
        sortedImpact.forEach(([team, netPoints], index) => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-100 dark:border-gray-700';
            const colorClass = netPoints > 0 ? 'text-green-500' : netPoints < 0 ? 'text-red-500' : '';
            row.innerHTML = `<td class="py-2 font-semibold">${index + 1}</td><td class="py-2">${team}</td><td class="py-2 font-bold ${colorClass}">${netPoints.toFixed(1)}</td>`;
            impactBody.appendChild(row);
        });
        const logBody = document.getElementById('transaction-log-body');
        logBody.innerHTML = '';
        transactionData.forEach(t => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-100 dark:border-gray-700';
            const typeClass = t.Type.toLowerCase() === 'add' ? 'text-green-500' : 'text-red-500';
            row.innerHTML = `<td class="py-2">${t.Player}</td><td class="py-2 font-semibold ${typeClass}">${t.Type}</td><td class="py-2">${t.Team}</td><td class="py-2">${t.Gameweek}</td>`;
            logBody.appendChild(row);
        });
    }

    function createTeamCheckboxes() {
      const teams = [...new Set(matchData.map(match => match.Team))].sort();
      const container = document.getElementById('team-checkboxes');
      container.innerHTML = '';
      teams.forEach((team, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        const isChecked = index < 3 ? 'checked' : ''; 
        div.innerHTML = `<input type="checkbox" id="team-${index}" value="${team}" ${isChecked} onchange="updateLeagueView()" class="rounded text-blue-600"><label for="team-${index}" class="text-sm truncate">${team}</label>`;
        container.appendChild(div);
      });
    }

    function initializeCharts() {
      if (Object.keys(charts).length === 0) {
        createScoreTrendsChart();
        createWinTrendsChart();
        createWinRateChart();
        createPerformanceMatrixChart();
        createTeamCheckboxes(); 
      }
      updateLeagueView();
    }

    function createChart(id, type, options) {
        const ctx = document.getElementById(id).getContext('2d');
        return new Chart(ctx, { type, data: { labels: [], datasets: [] }, options });
    }

    function createScoreTrendsChart() { charts.scoreTrends = createChart('score-trends-chart', 'line', { responsive: true, plugins: { legend: { labels: { color: '#9CA3AF' } } }, scales: { x: { ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } }, y: { ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } } } }); }
    function createWinTrendsChart() { charts.winTrends = createChart('win-trends-chart', 'line', { responsive: true, plugins: { legend: { labels: { color: '#9CA3AF' } } }, scales: { x: { ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } }, y: { ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } } } }); }
    function createWinRateChart() { charts.winRate = createChart('win-rate-chart', 'doughnut', { responsive: true, plugins: { legend: { position: 'right', labels: { color: '#9CA3AF' } } } }); }
    function createPerformanceMatrixChart() { charts.performanceMatrix = createChart('performance-matrix-chart', 'scatter', { responsive: true, plugins: { legend: { labels: { color: '#9CA3AF' } } }, scales: { x: { title: { display: true, text: 'Average Score', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } }, y: { title: { display: true, text: 'Win Rate (%)', color: '#9CA3AF' }, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } } } }); }
    
    function updateLeagueView() {
      if(Object.keys(charts).length === 0) return;
      const selectedTeams = Array.from(document.querySelectorAll('#team-checkboxes input[type="checkbox"]:checked')).map(cb => cb.value);
      updateScoreLineChart(selectedTeams);
      updateWinTrendsChart(selectedTeams);
      updateWinRateChart(selectedTeams);
      updatePerformanceMatrixChart(selectedTeams);
      renderStandings(selectedTeams);
    }
    
    function updateScoreLineChart(selectedTeams) {
        const chartType = document.getElementById('score-chart-selector').value;
        document.getElementById('score-chart-title').innerText = chartType === 'weekly' ? 'Score Trends by Gameweek' : 'Cumulative Score Trends';
        const gameweeks = [...new Set(matchData.map(match => match.Gameweek))].sort((a, b) => parseInt(a) - parseInt(b));
        let datasets = [];
        if (chartType === 'weekly') {
            datasets = selectedTeams.map(team => ({ label: team, data: gameweeks.map(gw => (matchData.find(m => m.Team === team && m.Gameweek === gw) || {}).Score || null), borderColor: getTeamColor(team), backgroundColor: getTeamColor(team) + '20', tension: 0.4 }));
        } else {
            datasets = selectedTeams.map(team => {
                let cumulativeScore = 0;
                return { label: team, data: gameweeks.map(gw => { cumulativeScore += parseFloat((matchData.find(m => m.Team === team && m.Gameweek === gw) || {}).Score || 0); return cumulativeScore.toFixed(2); }), borderColor: getTeamColor(team), backgroundColor: getTeamColor(team) + '20', tension: 0.4 };
            });
        }
        charts.scoreTrends.data = { labels: gameweeks.map(gw => `GW${gw}`), datasets };
        charts.scoreTrends.update();
    }
    
    function updateWinTrendsChart(selectedTeams) {
        const chartType = document.getElementById('win-trends-selector').value;
        document.getElementById('win-trends-title').innerText = chartType === 'cumulative' ? 'Cumulative Wins by Gameweek' : 'Match Results by Gameweek';
        const gameweeks = [...new Set(matchData.map(match => match.Gameweek))].sort((a, b) => parseInt(a) - parseInt(b));
        let datasets = [], yAxisOptions = { ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } };
        if (chartType === 'cumulative') {
            yAxisOptions.ticks.stepSize = 1;
            datasets = selectedTeams.map(team => {
                let winCount = 0;
                return { label: team, data: gameweeks.map(gw => { const match = matchData.find(m => m.Team === team && m.Gameweek === gw); if (match && match.Result === 'W') winCount++; return winCount; }), borderColor: getTeamColor(team), backgroundColor: getTeamColor(team) + '20', tension: 0.1, stepped: true };
            });
        } else {
            yAxisOptions.ticks = { color: '#9CA3AF', stepSize: 1, callback: v => (v === 1 ? 'Win' : v === 0 ? 'Loss' : null) };
            yAxisOptions.min = -0.1; yAxisOptions.max = 1.1;
            datasets = selectedTeams.map(team => ({ label: team, data: gameweeks.map(gw => { const match = matchData.find(m => m.Team === team && m.Gameweek === gw); return match ? (match.Result === 'W' ? 1 : 0) : null; }), borderColor: getTeamColor(team), backgroundColor: getTeamColor(team) + '20', stepped: true }));
        }
        charts.winTrends.options.scales.y = yAxisOptions;
        charts.winTrends.data = { labels: gameweeks.map(gw => `GW${gw}`), datasets };
        charts.winTrends.update();
    }
    
    function updateWinRateChart(selectedTeams) {
      const winRates = selectedTeams.map(team => {
        const teamMatches = matchData.filter(match => match.Team === team);
        const wins = teamMatches.filter(match => match.Result === 'W').length;
        return teamMatches.length > 0 ? ((wins / teamMatches.length) * 100).toFixed(1) : 0;
      });
      charts.winRate.data.labels = selectedTeams;
      charts.winRate.data.datasets[0] = { data: winRates, backgroundColor: selectedTeams.map(team => getTeamColor(team)) };
      charts.winRate.update();
    }
    
    function updatePerformanceMatrixChart(selectedTeams) {
      const datasets = selectedTeams.map(team => {
        const teamMatches = matchData.filter(match => match.Team === team);
        if (teamMatches.length === 0) return {};
        const avgScore = teamMatches.reduce((sum, match) => sum + parseFloat(match.Score), 0) / teamMatches.length;
        const wins = teamMatches.filter(match => match.Result === 'W').length;
        const winRate = (wins / teamMatches.length) * 100;
        return { label: team, data: [{ x: avgScore, y: winRate }], backgroundColor: getTeamColor(team), pointRadius: 8 };
      });
      charts.performanceMatrix.data.datasets = datasets;
      charts.performanceMatrix.update();
    }

document.addEventListener("DOMContentLoaded", () => {
    parseMatchData();
    
    // --- MODIFIED: Set the first gameweek you have data for ---
    const START_GAMEWEEK = 4;
    
    const filesToLoad = ['transactions.csv'];
    // Loop only from the start week to the current week
    for (let i = START_GAMEWEEK; i <= CURRENT_GAMEWEEK; i++) { 
        filesToLoad.push(`ref_gw${i}.csv`); 
    }

    const promises = filesToLoad.map(file => new Promise((resolve) => {
        Papa.parse(file, {
            download: true, header: true, skipEmptyLines: true,
            complete: results => resolve({ file, status: 'fulfilled', data: results.data }),
            error: (err) => resolve({ file, status: 'rejected', error: err })
        });
    }));

    Promise.all(promises).then(results => {
        const transactionResult = results[0];
        if (transactionResult.status === 'fulfilled') {
            transactionData = transactionResult.data;
        } else {
            console.error("CRITICAL: transactions.csv failed to load.");
            document.getElementById('impact-analysis-body').innerHTML = `<tr><td colspan="3" class="text-red-500 py-4">Error: Could not load transactions.csv.</td></tr>`;
        }

        weeklyPlayerData = {};
        results.slice(1).forEach(result => {
            if (result.status === 'fulfilled') {
                // Extract gameweek number from filename e.g., "ref_gw4.csv" -> 4
                const gw = result.file.match(/_gw(\d+)/)[1];
                weeklyPlayerData[gw] = result.data;
            } else {
                console.warn(`Could not load ${result.file}. It will be skipped.`);
            }
        });
        console.log("Data loading finished.");

        const latestPlayerData = weeklyPlayerData[CURRENT_GAMEWEEK] || [];
        
        if (latestPlayerData.length > 0) {
            document.getElementById('player-stats-title').innerText = `Player Statistics (Gameweek ${CURRENT_GAMEWEEK})`;
            document.getElementById("total-players").innerText = latestPlayerData.length;
            const topScorer = latestPlayerData.reduce((a, b) => (parseFloat(a["FPts"] || 0) > parseFloat(b["FPts"] || 0)) ? a : b, { Player: 'N/A', FPts: 0 });
            document.getElementById("top-scorer-name").innerText = topScorer["Player"];
            document.getElementById("top-scorer-pts").innerText = `${topScorer["FPts"]} FPts`;
            const avgPts = (latestPlayerData.reduce((sum, p) => sum + parseFloat(p["FPts"] || 0), 0) / latestPlayerData.length || 0).toFixed(1);
            document.getElementById("avg-points").innerText = avgPts;

            if ($.fn.DataTable.isDataTable('#players-table')) { $('#players-table').DataTable().destroy(); }
            $('#players-table').DataTable({
                data: latestPlayerData,
                columns: Object.keys(latestPlayerData[0]).map(k => ({ title: k, data: k })),
                pageLength: 15, order: [[6, 'desc']], responsive: true, dom: 'Bfrtip',
                language: { search: "Search players:", lengthMenu: "Show _MENU_ players", info: "Showing _START_ to _END_ of _TOTAL_ players" }
            });
        } else {
             document.getElementById('player-stats-title').innerText = `Player Statistics (Data Unavailable for GW${CURRENT_GAMEWEEK})`;
        }
        
        calculateAndRenderImpact();
        showSection('league');
    });
});
  </script>

  <style>
    .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter, .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate { color: #9CA3AF; }
    .dataTables_wrapper .dataTables_paginate .paginate_button { color: #9CA3AF !important; }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background: #374151 !important; border-color: #374151 !important; }
    .dataTables_wrapper table.dataTable tbody tr { background-color: transparent; }
    .dataTables_wrapper table.dataTable tbody tr:hover { background-color: rgba(55, 65, 81, 0.5) !important; }
    .section-content { transition: opacity 0.3s ease-in-out; }
    .section-content.hidden { opacity: 0; display: none; }
    input[type="checkbox"] { accent-color: #3B82F6; }
    canvas { max-height: 300px !important; }
    @media (max-width: 1024px) { #performance-matrix-chart { max-height: 400px !important; } }
  </style>
</body>
</html>
