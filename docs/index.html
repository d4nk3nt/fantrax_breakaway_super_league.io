<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Football Analytics Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

  <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 p-4">
    <div class="flex space-x-8 items-center">
      <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">Analytics Dashboard</h1>
      <div class="flex space-x-6">
        <button onclick="showSection('league')" class="nav-btn text-lg font-semibold text-blue-600 dark:text-blue-400 border-b-2 border-blue-600 dark:border-blue-400 pb-1" data-section="league">
          League
        </button>
        <button onclick="showSection('players')" class="nav-btn text-lg font-semibold text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200" data-section="players">
          Players
        </button>
      </div>
    </div>
  </header>

  <section id="league-section" class="section-content">
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <p class="text-gray-500 dark:text-gray-400 text-sm">Current Gameweek</p>
                <h2 id="current-gameweek" class="text-3xl font-bold">5</h2>
            </div>
        </div>
    </div>

    <div class="p-6 pt-0">
      <div class="mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
          <h3 class="text-lg font-semibold mb-4">Select Teams to Compare</h3>
          <div id="team-checkboxes" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
            </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="score-chart-title" class="text-lg font-semibold">Score Trends by Gameweek</h3>
                <select id="score-chart-selector" onchange="updateLeagueView()" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                    <option value="weekly" selected>Weekly Score</option>
                    <option value="cumulative">Cumulative Score</option>
                </select>
            </div>
            <canvas id="score-trends-chart" width="400" height="300"></canvas>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="win-trends-title" class="text-lg font-semibold">Cumulative Wins</h3>
                <select id="win-trends-selector" onchange="updateLeagueView()" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                    <option value="cumulative" selected>Cumulative Wins</option>
                    <option value="result">Match Result</option>
                </select>
            </div>
            <canvas id="win-trends-chart" width="400" height="300"></canvas>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
          <h3 class="text-lg font-semibold mb-4">Win Rate by Team</h3>
          <canvas id="win-rate-chart" width="400" height="300"></canvas>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold mb-4">Team Performance Matrix</h3>
            <canvas id="performance-matrix-chart" width="800" height="400"></canvas>
        </div>
      </div>
      
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
        <h3 class="text-xl font-bold mb-4">League Standings</h3>
        <div class="overflow-x-auto">
          <table id="standings-table" class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-700">
                <th class="text-left py-2">Pos</th>
                <th class="text-left py-2">Team</th>
                <th class="text-left py-2">W</th>
                <th class="text-left py-2">L</th>
                <th class="text-left py-2">Points For</th>
                <th class="text-left py-2">Points Against</th>
                <th class="text-left py-2">Avg Score</th>
              </tr>
            </thead>
            <tbody id="standings-body">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <section id="players-section" class="section-content hidden">
    <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <p class="text-gray-500 dark:text-gray-400 text-sm">Total Players</p>
                <h2 id="total-players" class="text-3xl font-bold">0</h2>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <p class="text-gray-500 dark:text-gray-400 text-sm">Top Scorer (Latest GW)</p>
                <h2 id="top-scorer-name" class="text-xl font-bold">Loading...</h2>
                <p id="top-scorer-pts" class="text-sm">-- FPts</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <p class="text-gray-500 dark:text-gray-400 text-sm">Avg. Points (Latest GW)</p>
                <h2 id="avg-points" class="text-3xl font-bold">0</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Transaction Impact Analysis</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Actual net points gained or lost from player adds/drops over the season.</p>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-200 dark:border-gray-700">
                            <th class="text-left py-2">Rank</th>
                            <th class="text-left py-2">Team</th>
                            <th class="text-left py-2">Net Points Impact</th>
                        </tr>
                    </thead>
                    <tbody id="impact-analysis-body">
                        </tbody>
                </table>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                <h3 class="text-xl font-bold mb-4">Recent Transactions</h3>
                <div class="overflow-y-auto h-64">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <th class="text-left py-2">Player</th>
                                <th class="text-left py-2">Type</th>
                                <th class="text-left py-2">Team</th>
                                <th class="text-left py-2">GW</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-log-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

      <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
        <h3 class="text-xl font-bold mb-4">Player Statistics (Gameweek 5)</h3>
        <table id="players-table" class="display stripe hover w-full text-sm"></table>
      </div>
    </div>
  </section>

  <script>
    // Global variables
    let matchData = [];
    let transactionData = [];
    let weeklyPlayerData = {}; // Store weekly data like {1: [...], 2: [...]}
    let charts = {};
    const CURRENT_GAMEWEEK = 5;

    // Team-color mapping
    const teamColors = { "Book Ake": "#4299E1", "Bryan MBeumboclaat": "#E53E3E", "Chicken Tikka MoSalah": "#38A169", "Ekitiki-taka": "#ECC94B", "ESRs EDL for FPL": "#9F7AEA", "FPL Loyalists": "#ED8936", "Haile Senesi": "#3182CE", "I'm a Baleba": "#D53F8C", "Infantino Milan": "#4FD1C5", "Iwobi Wan-Kenobi": "#F6AD55", "Me,Myself,Ndiaye": "#805AD5", "Texas Chainshaw Massacre": "#2C7A7B", "Ugarte roll with it": "#A0AEC0" };
    function getTeamColor(teamName) { return teamColors[teamName] || '#9CA3AF'; }

    // Embedded match records data
    const matchRecordsCSV = `...`; // Unchanged, snipped for brevity

    // Navigation and Static Data Parsing
    function showSection(sectionName) { /* ... unchanged ... */ }
    function parseMatchData() { /* ... unchanged ... */ }
    
    // Core Calculation Logic
    function calculateStandings() { /* ... unchanged ... */ }
    
    function calculateAndRenderImpact() {
        if (Object.keys(weeklyPlayerData).length === 0 || transactionData.length === 0) {
            console.log("Waiting for data to calculate impact...");
            return;
        }
        
        const impact = {};
        const allTeams = [...new Set(matchData.map(m => m.Team))];
        allTeams.forEach(team => impact[team] = 0);

        transactionData.forEach(t => {
            const transactionGW = parseInt(t.Gameweek);
            if (!transactionGW) return;

            let actualPoints = 0;
            // Loop from the week of the transaction to the current week
            for (let gw = transactionGW; gw <= CURRENT_GAMEWEEK; gw++) {
                const weeklyData = weeklyPlayerData[gw];
                if (!weeklyData) continue;

                const playerStats = weeklyData.find(p => p.Player === t.Player);
                if (playerStats) {
                    actualPoints += parseFloat(playerStats['FPts']) || 0;
                }
            }

            if (t.Type.toLowerCase() === 'add') {
                impact[t.Team] += actualPoints;
            } else if (t.Type.toLowerCase() === 'drop') {
                impact[t.Team] -= actualPoints;
            }
        });

        const sortedImpact = Object.entries(impact).sort(([,a],[,b]) => b - a);
        const impactBody = document.getElementById('impact-analysis-body');
        impactBody.innerHTML = '';
        sortedImpact.forEach(([team, netPoints], index) => { /* ... unchanged ... */ });

        const logBody = document.getElementById('transaction-log-body');
        logBody.innerHTML = '';
        transactionData.forEach(t => { /* ... unchanged ... */ });
    }

    // Rendering and Initialization
    function renderStandings(selectedTeams) { /* ... unchanged ... */ }
    function createTeamCheckboxes() { /* ... unchanged ... */ }
    function initializeCharts() { /* ... unchanged ... */ }
    
    // Chart Creation Functions (all unchanged)
    function createScoreTrendsChart() { /* ... */ }
    function createWinTrendsChart() { /* ... */ }
    function createWinRateChart() { /* ... */ }
    function createPerformanceMatrixChart() { /* ... */ }

    // Master update function for the entire league view
    function updateLeagueView() { /* ... unchanged ... */ }
    
    // Chart Update Functions (all unchanged)
    function updateScoreLineChart(selectedTeams) { /* ... */ }
    function updateWinTrendsChart(selectedTeams) { /* ... */ }
    function updateWinRateChart(selectedTeams) { /* ... */ }
    function updatePerformanceMatrixChart(selectedTeams) { /* ... */ }

    // Initialize everything when page loads
    document.addEventListener("DOMContentLoaded", () => {
        parseMatchData();
        
        // --- NEW: Asynchronous data loading for all CSV files ---
        const filesToLoad = ['transactions.csv'];
        for (let i = 1; i <= CURRENT_GAMEWEEK; i++) {
            filesToLoad.push(`ref_gw${i}.csv`);
        }

        const promises = filesToLoad.map(file => {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: results => resolve(results.data),
                    error: err => reject(err)
                });
            });
        });

        Promise.all(promises).then(results => {
            // Assign parsed data to global variables
            transactionData = results[0];
            for (let i = 1; i <= CURRENT_GAMEWEEK; i++) {
                weeklyPlayerData[i] = results[i];
            }
            console.log("All weekly player data and transactions loaded.", weeklyPlayerData);

            // Use the latest gameweek's data for KPIs and main player table
            const latestPlayerData = weeklyPlayerData[CURRENT_GAMEWEEK] || [];
            
            // Update player KPIs
            document.getElementById("total-players").innerText = latestPlayerData.length;
            const topScorer = latestPlayerData.reduce((a, b) => parseFloat(a["FPts"] || 0) > parseFloat(b["FPts"] || 0) ? a : b, { Player: 'N/A', FPts: 0 });
            document.getElementById("top-scorer-name").innerText = topScorer["Player"];
            document.getElementById("top-scorer-pts").innerText = `${topScorer["FPts"]} FPts`;
            const avgPts = (latestPlayerData.reduce((sum, p) => sum + parseFloat(p["FPts"] || 0), 0) / latestPlayerData.length || 0).toFixed(1);
            document.getElementById("avg-points").innerText = avgPts;

            // Initialize player stats table with latest data
            if ($.fn.DataTable.isDataTable('#players-table')) {
                $('#players-table').DataTable().destroy();
            }
            $('#players-table').DataTable({
                data: latestPlayerData.map(p => Object.values(p)),
                columns: (latestPlayerData[0] ? Object.keys(latestPlayerData[0]) : []).map(k => ({ title: k })),
                pageLength: 15,
                order: [[6, 'desc']], // Assuming FPts is the 7th column
                responsive: true,
                dom: 'Bfrtip',
                language: { search: "Search players:", lengthMenu: "Show _MENU_ players", info: "Showing _START_ to _END_ of _TOTAL_ players" }
            });

            // Now that ALL data is loaded, run the impact analysis
            calculateAndRenderImpact();

        }).catch(error => {
            console.error("Failed to load one or more essential data files:", error);
            // You could display an error message on the page here
        });
      
        showSection('league');
    });
  </script>

  <style>
    /* Custom styles for better dark mode support */
    .dataTables_wrapper .dataTables_length, .dataTables_wrapper .dataTables_filter, .dataTables_wrapper .dataTables_info, .dataTables_wrapper .dataTables_paginate { color: #9CA3AF; }
    .dataTables_wrapper .dataTables_paginate .paginate_button { color: #9CA3AF !important; }
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background: #374151 !important; border-color: #374151 !important; }
    .dataTables_wrapper table.dataTable tbody tr { background-color: transparent; }
    .dataTables_wrapper table.dataTable tbody tr:hover { background-color: rgba(55, 65, 81, 0.5) !important; }
    .section-content { transition: opacity 0.3s ease-in-out; }
    .section-content.hidden { opacity: 0; display: none; }
    input[type="checkbox"] { accent-color: #3B82F6; }
    canvas { max-height: 300px !important; }
    @media (max-width: 1024px) {
        #performance-matrix-chart {
            max-height: 400px !important;
        }
    }
  </style>
</body>
</html>